<!--
/************************************************************************************
* Copyright (c) 2015 -- 2017 by Fraunhofer Fokus
************************************************************************************/
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>reTHINK Catalogue Test Page</title>
    <script src="angular.js"></script>
</head>
<body>
<div ng-app="rethinkTest" ng-controller="myCtrl">
    <h1>reTHINK Catalogue Test Page</h1>
    <b>Attention: Use catalogue-rethink.fokus.fraunhofer.de as a broker address to access a publicly available instance.</b>
    <table>
        <tr>
            <td>Catalogue Broker hostname:</td>
            <td><input size="30" type="text" ng-model="host" ng-init="host = 'localhost'"></td>
        </tr>
        <tr>
            <td>Catalogue Broker protocol:</td>
            <td><select name="singleSelect" ng-model="protocol"
                        ng-init="protocol = 'https'" ng-change="protocol == 'http' ? port = 80 : port = 443">
                <option value="http">http</option>
                <option value="https">https</option>
            </select></td>
        </tr>
        <tr>
            <td align="right">Set port manually?</td>
            <td><input type="checkbox" ng-model="manualPort">{{manualPort ? "yes" : "no"}}</td>
        </tr>
        <tr ng-show="manualPort">
            <td>Catalogue Broker port:</td>
            <td><input type="number"
                       ng-model="port"
                       ng-init="protocol == 'http' ? port = 80 : port = 443"></td>
        </tr>
        <tr>
            <td>Catalogue Object type:</td>
            <td><select name="singleSelect" ng-model="kind" ng-init="kind = 'hyperty'"
                        ng-change="name = null; resourceName = null">
                <option value="hyperty">Hyperty</option>
                <option value="protocolstub">Protostub</option>
                <option value="runtime">Hyperty Runtime</option>
                <option value="dataschema">DataSchema</option>
                <option value="sourcepackage">SourcePackage</option>
            </select></td>
        </tr>
        <tr ng-show="kind != null">
            <td>(optional) Object name:</td>
            <td><input size="30" type="text" ng-model="name" ng-init="name = 'FirstHyperty'"
                       ng-change="name = name == '' ? null : name"></td>
        </tr>
        <tr ng-show="name != null">
            <td>(optional) Resource name:</td>
            <td><select name="singleSelect" ng-model="resourceName"
                        ng-change="resourceName = resourceName == '' ? null : resourceName">

                <!-- empty option -->
                <option></option>

                <!-- generic attributes, hide if source package is selected -->
                <option ng-hide="kind == 'sourcepackage'" value="cguid">cguid</option>
                <option ng-hide="kind == 'sourcepackage'" value="version">version</option>
                <option ng-hide="kind == 'sourcepackage'" value="description">description</option>
                <option ng-hide="kind == 'sourcepackage'" value="objectName">objectName</option>
                <option ng-hide="kind == 'sourcepackage'" value="sourcePackageURL">sourcePackageURL</option>
                <option ng-hide="kind == 'sourcepackage'" value="sourcePackage">sourcePackage</option>
                <option ng-hide="kind == 'sourcepackage'" value="language">language</option>
                <option ng-hide="kind == 'sourcepackage'" value="signature">signature</option>

                <!-- hyperty specific -->
                <option ng-show="kind == 'hyperty'" value="hypertyType">hypertyType</option>
                <option ng-show="kind == 'hyperty'" value="messageSchema">messageSchema</option>
                <option ng-show="kind == 'hyperty'" value="configuration">configuration</option>
                <option ng-show="kind == 'hyperty'" value="constraints">constraints</option>
                <option ng-show="kind == 'hyperty'" value="dataObjects">dataObjects</option>
                <option ng-show="kind == 'hyperty'" value="policies">policies</option>

                <!-- protocolstub specific -->
                <option ng-show="kind == 'protocolstub'" value="messageSchemas">messageSchemas</option>
                <option ng-show="kind == 'protocolstub'" value="configuration">configuration</option>
                <option ng-show="kind == 'protocolstub'" value="constraints">constraints</option>

                <!-- runtime specific -->
                <option ng-show="kind == 'runtime'" value="runtimeType">runtimeType</option>
                <option ng-show="kind == 'runtime'" value="hypertyCapabilities">hypertyCapabilities</option>
                <option ng-show="kind == 'runtime'" value="protocolCapabilities">protocolCapabilities</option>

                <!-- data schema specific -->
                <option ng-show="kind == 'dataschema'" value="accessControlPolicy">accessControlPolicy</option>

                <!-- source package specific-->
                <option ng-show="kind == 'sourcepackage'" value="encoding">encoding</option>
                <option ng-show="kind == 'sourcepackage'" value="sourceCodeClassname">sourceCodeClassname</option>
                <option ng-show="kind == 'sourcepackage'" value="sourceCode">sourceCode</option>
                <option ng-show="kind == 'sourcepackage'" value="signature">signature</option>
            </select></td>
        </tr>
    </table>

    <div ng-show="host != null && kind != null">
        <!-- TODO: improve code -->
        <h2>Generated path:<br>
            {{address = protocol + "://" + host + (manualPort ? ":" + port : "")+ "/.well-known/" + kind + "/" + (name
            == null ? '' : name) + (resourceName != null ? "/" + resourceName : "")}}</h2>
        <button ng-click="response = getResource(address)" ng-init="response = null">get {{name || kind}}</button>
        <button ng-click="response = getAndExecCode(getResource(address + '/sourcePackageURL'))">get & execute code
        </button>


        <div ng-show="response != null">
            <br>
            Response:
            <pre>{{response | json}}</pre>
        </div>

    </div>

    <p>---------------------------</p>
    <button ng-click="debug = !debug" ng-init="debug = false">Toggle Debug Info</button>
    <div ng-show="debug">
        <table border="1">
            <tr>
                <td align="right">host</td>
                <td>{{host}}</td>
            </tr>
            <tr>
                <td align="right">port</td>
                <td>{{port}}</td>
            </tr>
            <tr>
                <td align="right">address</td>
                <td>{{address}}</td>
            </tr>
            <tr>
                <td align="right">kind</td>
                <td>{{kind}}</td>
            </tr>
            <tr>
                <td align="right">name</td>
                <td>{{name}}</td>
            </tr>
            <tr>
                <td align="right">resourceName</td>
                <td>{{resourceName}}</td>
            </tr>
            <tr>
                <td align="right">response</td>
                <td>
                    <pre>{{response | json}}</pre>
                </td>
            </tr>
        </table>
    </div>


</div>
<script>
    var app = angular.module('rethinkTest', []);
    app.controller('myCtrl', function ($scope) {


        $scope.getResource = function (url) {
//            var url = "http://" + address + "/.well-known/" + kind + "/" + name;
            console.log("trying to send a request to: " + url);

            var xmlHttp = new XMLHttpRequest();
            try {
                xmlHttp.open("GET", url, false); // false for synchronous request
                xmlHttp.send(null);
            } catch (e) {
                alert("Error while trying to get resource:\r\n" + e);
                return;
            }
            console.log("got response: " + xmlHttp.responseText);
            var resp = xmlHttp.responseText;

            try {
                resp = JSON.parse(xmlHttp.responseText);
            } catch (e) {
//                alert("Error trying to parse json:\r\n" + resp + "\r\nerror: " + e);
                console.log("json parsing failed, probably not json:", resp);
            }


            return resp;
        };


        $scope.getAndExecCode = function (url) {
            console.log("getting sourcePackage from:", url);
            try {
                var resp = $scope.getResource(url);
                console.log("got raw package:", resp);
                var sourcePackage = resp;
                var code = sourcePackage.sourceCode;

                if (sourcePackage.encoding === "base64")
                    code = atob(code);

                console.log("About to exec following code: " + code);
                eval(code);
                return resp;
            } catch (e) {
                alert("Error trying to execute code from url:\r\n" + url + "\r\n" + e);
            }
        };

//        window.getResource = $scope.getResource;

        var rethink = {};
        rethink.myalert = function (msg) {
            alert(msg || "this is a test!");
        };

        window.rethink = rethink;


    });
</script>
</body>
</html>