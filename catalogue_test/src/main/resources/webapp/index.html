<!--
/************************************************************************************
* Copyright (c) 2015 -- 2017 by Fraunhofer Fokus
************************************************************************************/
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>reTHINK catalogue broker test page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.js"></script>
</head>
<body>
<h1>reTHINK catalogue broker test page</h1>

<div ng-app="rethinkTest" ng-controller="myCtrl">
    <p>reTHINK broker address : <input type="text" ng-model="address" ng-init="address = 'localhost:8080'"></p>

    <p> Kind:
        <select name="singleSelect" ng-model="kind">
            <option value="hyperty">Hyperty</option>
            <option value="protostub">Protostub</option>
        </select>
    </p>
    <div ng-show="kind != null">
        <p>(optional) {{kind}} name: <input type="text" ng-model="name" ng-change="name = name == '' ? null : name"></p>
    </div>

    <div ng-show="address != null && kind != null">
        <div ng-show="name != null">
            <p> (optional) resource of {{name}}:
                <select name="singleSelect" ng-model="resourceName"
                        ng-change="resourceName = resourceName == '' ? null : resourceName">
                    <!--0: "guid"-->
                    <!--1: "id"-->
                    <!--2: "description"-->
                    <!--3: "kind"-->
                    <!--4: "catalogueURL"-->
                    <!--5: "sourceCode"-->
                    <!--6: "dataObject"-->
                    <!--7: "type"-->
                    <!--8: "messageSchema"-->
                    <!--9: "configuration"-->
                    <!--10: "policies"-->
                    <!--11: "constraints"-->
                    <!--12: "configuration"-->
                    <!--13: "hypertyCapabilities"-->
                    <!--14: "protocolCapabilities"-->

                    <option></option>
                    <option value="guid">guid</option>
                    <option value="id">id</option>
                    <option value="description">description</option>
                    <option value="kind">kind</option>
                    <option value="catalogueURL">catalogueURL</option>
                    <option value="sourceCode">sourceCode</option>
                    <option value="dataObject">dataObject</option>
                    <option value="type">type</option>
                    <option value="messageSchema">messageSchema</option>
                    <option value="configuration">configuration</option>
                    <option value="policies">policies</option>
                    <option value="constraints">constraints</option>
                    <option value="configuration">configuration</option>
                    <option value="hypertyCapabilities">hypertyCapabilities</option>
                    <option value="hypertyCapabilities">protocolCapabilities</option>
                </select>
            </p>
        </div>

        <!-- TODO: improve code -->
        <h3>Generated path:<br>
            {{"http://" + address + "/.well-known/" + kind + "/" + (name == null ? '' : name) + (resourceName != null ? "/" + resourceName : "")}}</h3>
        <button ng-click="response = getResource('http://' + address + '/.well-known/' + kind + '/' + (name == null ? '' : name) + (resourceName != null ? '/' + resourceName : ''))" ng-init="response = null">get {{name || kind}}</button>
        <button ng-click="response = getAndExecCode('http://' + address + '/.well-known/' + kind + '/' + name + '/sourceCode')">get & execute code</button>


        <div ng-show="response != null">
            <br>
            Response:<pre>{{response | json}}</pre>
        </div>

    </div>

    <br>
    ---------------------------------------------------<br>
    <button ng-click="debug = !debug" ng-init="debug = false">Toggle Debug Info</button>
    <div ng-show="debug">
        <table border="1">
            <tr>
                <td align="right">address</td>
                <td>{{address}}</td>
            </tr>
            <tr>
                <td align="right">kind</td>
                <td>{{kind}}</td>
            </tr>
            <tr>
                <td align="right">name</td>
                <td>{{name}}</td>
            </tr>
            <tr>
                <td align="right">resourceName</td>
                <td>{{resourceName}}</td>
            </tr>
            <tr>
                <td align="right">response</td>
                <td><pre>{{response}}</pre></td>
            </tr>
        </table>
    </div>


</div>
<script>
    var app = angular.module('rethinkTest', []);
    app.controller('myCtrl', function ($scope) {
        $scope.getResource = function(url) {
//            var url = "http://" + address + "/.well-known/" + kind + "/" + name;
            console.log("trying to send a request to: " + url);

            var xmlHttp = new XMLHttpRequest();
            try {
                xmlHttp.open("GET", url, false); // false for synchronous request
                xmlHttp.send(null);
            } catch (e) {
                alert("Error while trying to get resource:\r\n" + e);
                return;
            }
            console.log("got response: " + xmlHttp.responseText);
            var resp = xmlHttp.responseText;

            try {
                resp = JSON.parse(xmlHttp.responseText);
            } catch (e) {
                alert("Error trying to parse json:\r\n" + resp + "\r\nerror: " + e);
                return;
            }
            console.log("response json: ", resp);


            return resp;
        };


        $scope.getAndExecCode = function(url) {
            try {
                var respJson = getResource(url);
                var code = respJson.content.value;
                console.log("About to exec following code: " + code);
                eval(code);
                return respJson;
            } catch (e) {
                alert("Error trying to execute code from url:\r\n" + url);
            }
        };

        window.getResource = $scope.getResource;
    });
</script>
</body>
</html>